version: '3'

tasks:

  build:
    desc: 'Build the container'
    cmds:
      - |
        cd vegetation-indexes
        docker build -t vegetation-indexes:latest .
    silent: false

  stage:
    desc: 'Stage-in the Landsat data'
    cmds:
      - |
        cd stage-in
        hatch run stage-in --output-dir ../data "https://planetarycomputer.microsoft.com/api/stac/v1/collections/landsat-c2-l2/items/LC08_L2SP_042033_20231007_02_T1"
        hatch run stage-in --output-dir ../data "https://planetarycomputer.microsoft.com/api/stac/v1/collections/landsat-c2-l2/items/LC09_L2SP_042033_20231015_02_T1"
    silent: false

  pattern-1:
    desc: |
      Run pattern 1: one input parameter of type `Directory`, one output parameter of type `Directory`
    cmds:
      - |
        cd vegetation-indexes
        hatch run \
          vegetation-index pattern-1 \
          --input-item ../data/LC09_L2SP_042033_20231015_02_T1 \
          --aoi="-118.985,38.432,-118.183,38.938" \
          --epsg "EPSG:4326" \
          --band green \
          --band nir08
    silent: false

  pattern-1-cwl:
    desc: |
      Run pattern 1 using CWL: one input parameter of type `Directory`, one output parameter of type `Directory`
    cmds:
      - defer: rm -fv .params.yaml
      - |
        echo 'item: {"class": "Directory", "path": "data/LC09_L2SP_042033_20231015_02_T1"}' > .params.yaml
        echo 'aoi: "-118.985,38.432,-118.183,38.938"' >> .params.yaml
        echo 'epsg: "EPSG:4326"' >> .params.yaml
        echo 'band: ["green", "nir08"]' >> .params.yaml
        cwltool cwl-workflow/pattern-1.cwl#water-bodies-detection .params.yaml
    silent: false

  pattern-1-wrap:
    desc: |
      Wrap pattern 1 using eoap-cwlwrap
    cmds:
      - |
        s="clt" t="ghcr.io/eoap/application-package-patterns/vegetation-indexes:0.1.0" yq -i eval '(.$graph[] | select (.id == env(s)) ).hints.DockerRequirement.dockerPull = env(t)' -i cwl-workflow/pattern-1.cwl 
        eoap-cwlwrap \
          --stage-in templates/stage-in.cwl \
          --stage-out templates/stage-out.cwl \
          --workflow cwl-workflow/pattern-1.cwl \
          --workflow-id water-bodies-detection \
          --output wrapped-cwl-workflow/pattern-1.cwl

  pattern-2:
    desc: 'Run pattern 2'
    cmds:
      - |
        cd vegetation-indexes
        hatch run \
          vegetation-index pattern-2 \
          --input-item-1 ../data/LC08_L2SP_042033_20231007_02_T1/ \
          --input-item-2 ../data/LC09_L2SP_042033_20231015_02_T1/  \
          --aoi="-118.985,38.432,-118.183,38.938" \
          --epsg "EPSG:4326" \
          --band green \
          --band nir08
    silent: false
  
  pattern-2-cwl:
    desc: |
      Run pattern 2 using CWL: two input parameters of type `Directory` and one output parameter of type `Directory`
    cmds:
      - defer: rm -fv .params.yaml
      - |
        echo 'item_1: {"class": "Directory", "path": "data/LC08_L2SP_042033_20231007_02_T1"}' > .params.yaml
        echo 'item_2: {"class": "Directory", "path": "data/LC09_L2SP_042033_20231015_02_T1"}' >> .params.yaml
        echo 'aoi: "-118.985,38.432,-118.183,38.938"' >> .params.yaml
        echo 'epsg: "EPSG:4326"' >> .params.yaml
        echo 'band: ["green", "nir08"]' >> .params.yaml
        cwltool cwl-workflow/pattern-2.cwl .params.yaml
    silent: false

  pattern-3:
    desc: 'Run pattern 3'
    cmds:
      - |
        cd vegetation-indexes
        hatch run \
          vegetation-index pattern-3 \
          --input-item ../data/LC08_L2SP_042033_20231007_02_T1/ \
          --aoi="-118.985,38.432,-118.183,38.938" \
          --epsg "EPSG:4326" \
          --band green \
          --band nir08
    silent: false

  pattern-3-cwl:
    desc: 'Run pattern 3 using CWL'
    cmds:
      - defer: rm -fv .params.yaml
      - |
        echo 'items:' > .params.yaml
        echo '- {"class": "Directory", "path": "data/LC09_L2SP_042033_20231015_02_T1"}' >> .params.yaml
        echo '- {"class": "Directory", "path": "data/LC08_L2SP_042033_20231007_02_T1"}' >> .params.yaml
        echo 'aoi: "-118.985,38.432,-118.183,38.938"' >> .params.yaml
        echo 'epsg: "EPSG:4326"' >> .params.yaml
        cwltool cwl-workflow/pattern-3.cwl .params.yaml
    silent: false


  pattern-4:
    desc: 'Run pattern 4'
    cmds:
      - |
        cd vegetation-indexes
        hatch run \
          vegetation-index pattern-4 \
          --input-item ../data/LC08_L2SP_042033_20231007_02_T1/ \
          --aoi="-118.985,38.432,-118.183,38.938" \
          --epsg "EPSG:4326"
    silent: false

  pattern-4-cwl:
    desc: 'Run pattern 4 using CWL'
    cmds:
      - defer: rm -fv .params.yaml
      - |
        echo 'item: {"class": "Directory", "path": "data/LC09_L2SP_042033_20231015_02_T1"}' > .params.yaml
        echo 'aoi: "-118.985,38.432,-118.183,38.938"' >> .params.yaml
        echo 'epsg: "EPSG:4326"' >> .params.yaml
        cwltool cwl-workflow/pattern-4.cwl .params.yaml
    silent: false

  pattern-5:
    desc: 'Run pattern 5'
    cmds:
      - |
        cd vegetation-indexes
        hatch run \
          vegetation-index pattern-5 \
          --input-item ../data/LC08_L2SP_042033_20231007_02_T1/ \
          --aoi="-118.985,38.432,-118.183,38.938" \
          --epsg "EPSG:4326" \
          --vegetation-index ndwi
    silent: false

  pattern-5-cwl:
    desc: 'Run pattern 5 using CWL'
    cmds:
      - defer: rm -fv .params.yaml
      - |
        echo 'item: {"class": "Directory", "path": "data/LC09_L2SP_042033_20231015_02_T1"}' > .params.yaml
        echo 'aoi: "-118.985,38.432,-118.183,38.938"' >> .params.yaml
        echo 'epsg: "EPSG:4326"' >> .params.yaml
        echo 'vegetation_index: ["ndwi", "ndwi"]' >> .params.yaml
        cwltool cwl-workflow/pattern-5.cwl .params.yaml
    silent: false

  pattern-6:
    desc: 'Run pattern 6'
    cmds:
      - |
        cd vegetation-indexes
        hatch run \
          vegetation-index pattern-6 \
          --input-item ../data/LC08_L2SP_042033_20231007_02_T1/ \
          --aoi="-118.985,38.432,-118.183,38.938" \
          --epsg "EPSG:4326" 
    silent: false

  pattern-6-cwl:
    desc: 'Run pattern 6 using CWL'
    cmds:
      - defer: rm -fv .params.yaml
      - |
        echo 'item: {"class": "Directory", "path": "data/LC09_L2SP_042033_20231015_02_T1"}' > .params.yaml
        echo 'aoi: "-118.985,38.432,-118.183,38.938"' >> .params.yaml
        echo 'epsg: "EPSG:4326"' >> .params.yaml
        cwltool cwl-workflow/pattern-6.cwl .params.yaml
    silent: false

  pattern-7a:
    desc: |
      Run pattern 7a: one optional input parameter of type `Directory?` (set) and one output parameter of type `Directory'
    cmds:
      - |
        cd vegetation-indexes
        hatch run \
          vegetation-index pattern-7 \
          --input-item-1 ../data/LC08_L2SP_042033_20231007_02_T1/ \
          --input-item-2 ../data/LC09_L2SP_042033_20231015_02_T1/  \
          --aoi="-118.985,38.432,-118.183,38.938" \
          --epsg "EPSG:4326" \
          --band green \
          --band nir08
    silent: false

  pattern-7a-cwl:
    desc: |
      Run pattern 7a using CWL: one optional input parameter of type `Directory?` (set) and one output parameter of type `Directory`
    cmds:
      - defer: rm -fv .params.yaml
      - |
        echo 'item_1: {"class": "Directory", "path": "data/LC08_L2SP_042033_20231007_02_T1"}' > .params.yaml
        echo 'item_2: {"class": "Directory", "path": "data/LC09_L2SP_042033_20231015_02_T1"}' >> .params.yaml
        echo 'aoi: "-118.985,38.432,-118.183,38.938"' >> .params.yaml
        echo 'epsg: "EPSG:4326"' >> .params.yaml
        echo 'band: ["green", "nir08"]' >> .params.yaml
        cwltool cwl-workflow/pattern-7.cwl .params.yaml
    silent: false

  pattern-7b:
    desc: |
      Run pattern 7b: one optional input parameter of type `Directory?` (not set) and one output parameter of type `Directory'
    cmds:
      - |
        cd vegetation-indexes
        hatch run \
          vegetation-index pattern-7 \
          --input-item-1 ../data/LC08_L2SP_042033_20231007_02_T1/ \
          --aoi="-118.985,38.432,-118.183,38.938" \
          --epsg "EPSG:4326" \
          --band green \
          --band nir08
    silent: false

  pattern-7b-cwl:
    desc: |
      Run pattern 7b using CWL: one optional input parameter of type `Directory?` (not set) and one output parameter of type `Directory`
    cmds:
      - defer: rm -fv .params.yaml
      - |
        echo 'item_1: {"class": "Directory", "path": "data/LC08_L2SP_042033_20231007_02_T1"}' > .params.yaml
        echo 'aoi: "-118.985,38.432,-118.183,38.938"' >> .params.yaml
        echo 'epsg: "EPSG:4326"' >> .params.yaml
        echo 'band: ["green", "nir08"]' >> .params.yaml
        cwltool cwl-workflow/pattern-7.cwl .params.yaml
    silent: false

  pattern-8a:
    desc: |
      Run pattern 8: one input parameter of type `Directory`, one output parameter of type `Directory?` (set)
    cmds:
      - |
        cd vegetation-indexes
        hatch run \
          vegetation-index pattern-8 \
          --input-item ../data/LC09_L2SP_042033_20231015_02_T1 \
          --aoi="-118.985,38.432,-118.183,38.938" \
          --epsg "EPSG:4326" \
          --band green \
          --band nir08 \
          --produce-output
    silent: false

  pattern-8a-cwl:
    desc: |
      Run pattern 8 using CWL: one input parameter of type `Directory`, one output parameter of type `Directory?` (set)
    cmds:
      - defer: rm -fv .params.yaml
      - |
        echo 'item: {"class": "Directory", "path": "data/LC09_L2SP_042033_20231015_02_T1"}' > .params.yaml
        echo 'aoi: "-118.985,38.432,-118.183,38.938"' >> .params.yaml
        echo 'epsg: "EPSG:4326"' >> .params.yaml
        echo 'band: ["green", "nir08"]' >> .params.yaml
        echo 'produce_output: true' >> .params.yaml
        cwltool cwl-workflow/pattern-8.cwl#water-bodies-detection .params.yaml
    silent: false

  pattern-8b:
    desc: |
      Run pattern 8: one input parameter of type `Directory`, one output parameter of type `Directory?` (not set)
    cmds:
      - |
        cd vegetation-indexes
        hatch run \
          vegetation-index pattern-8 \
          --input-item ../data/LC09_L2SP_042033_20231015_02_T1 \
          --aoi="-118.985,38.432,-118.183,38.938" \
          --epsg "EPSG:4326" \
          --band green \
          --band nir08
    silent: false

  pattern-8b-cwl:
    desc: |
      Run pattern 8 using CWL: one input parameter of type `Directory`, one output parameter of type `Directory?` (not set)
    cmds:
      - defer: rm -fv .params.yaml
      - |
        echo 'item: {"class": "Directory", "path": "data/LC09_L2SP_042033_20231015_02_T1"}' > .params.yaml
        echo 'aoi: "-118.985,38.432,-118.183,38.938"' >> .params.yaml
        echo 'epsg: "EPSG:4326"' >> .params.yaml
        echo 'band: ["green", "nir08"]' >> .params.yaml
        echo 'produce_output: false' >> .params.yaml
        cwltool cwl-workflow/pattern-8.cwl#water-bodies-detection .params.yaml
    silent: false
    
  pattern-9a:
    desc: |
      Run pattern 9: one input parameter of type `Directory`, one output parameter of type `Directory[]?` (set)
    cmds:
      - |
        cd vegetation-indexes
        hatch run \
          vegetation-index pattern-9 \
          --input-item ../data/LC08_L2SP_042033_20231007_02_T1/ \
          --aoi="-118.985,38.432,-118.183,38.938" \
          --epsg "EPSG:4326" \
          --vegetation-index ndwi
    silent: false

  pattern-9a-cwl:
    desc: |
      Run pattern 9 using CWL: one input parameter of type `Directory`, one output parameter of type `Directory[]?` (set)
    cmds:
      - defer: rm -fv .params.yaml
      - |
        echo 'item: {"class": "Directory", "path": "data/LC09_L2SP_042033_20231015_02_T1"}' > .params.yaml
        echo 'aoi: "-118.985,38.432,-118.183,38.938"' >> .params.yaml
        echo 'epsg: "EPSG:4326"' >> .params.yaml
        echo 'indexes: ["ndwi", "ndwi"]' >> .params.yaml
        cwltool cwl-workflow/pattern-9.cwl .params.yaml
    silent: false
    

  pattern-9b:
    desc: |
      Run pattern 9: one input parameter of type `Directory`, one output parameter of type `Directory[]?` (not set)
    cmds:
      - |
        cd vegetation-indexes
        hatch run \
          vegetation-index pattern-9 \
          --input-item ../data/LC08_L2SP_042033_20231007_02_T1/ \
          --aoi="-118.985,38.432,-118.183,38.938" \
          --epsg "EPSG:4326" \
          --vegetation-index none
    silent: false

  pattern-9b-cwl:
    desc: |
      Run pattern 9 using CWL: one input parameter of type `Directory`, one output parameter of type `Directory[]?` (some set)
    cmds:
      - defer: rm -fv .params.yaml
      - |
        echo 'item: {"class": "Directory", "path": "data/LC09_L2SP_042033_20231015_02_T1"}' > .params.yaml
        echo 'aoi: "-118.985,38.432,-118.183,38.938"' >> .params.yaml
        echo 'epsg: "EPSG:4326"' >> .params.yaml
        echo 'indexes: ["ndwi", "ndwi", "none"]' >> .params.yaml
        cwltool cwl-workflow/pattern-9.cwl .params.yaml
    silent: false


  pattern-9c-cwl:
    desc: |
      Run pattern 9 using CWL: one input parameter of type `Directory`, one output parameter of type `Directory[]?` (none set)
    cmds:
      - defer: rm -fv .params.yaml
      - |
        echo 'item: {"class": "Directory", "path": "data/LC09_L2SP_042033_20231015_02_T1"}' > .params.yaml
        echo 'aoi: "-118.985,38.432,-118.183,38.938"' >> .params.yaml
        echo 'epsg: "EPSG:4326"' >> .params.yaml
        echo 'indexes: ["none", "none", "none"]' >> .params.yaml
        cwltool cwl-workflow/pattern-9.cwl .params.yaml
    silent: false

  pattern-10:
    desc: 'Run pattern 10'
    cmds:
      - |
        cd vegetation-indexes
        hatch run \
          vegetation-index pattern-5 \
          --input-item ../data/LC08_L2SP_042033_20231007_02_T1/ \
          --aoi="-118.985,38.432,-118.183,38.938" \
          --epsg "EPSG:4326" \
          --vegetation-index ndwi
    silent: false

  pattern-10-cwl:
    desc: 'Run pattern 10 using CWL'
    cmds:
      - defer: rm -fv .params.yaml
      - |
        echo 'item:' > .params.yaml
        echo '  - {"class": "Directory", "path": "data/LC09_L2SP_042033_20231015_02_T1"}' >> .params.yaml
        echo '  - {"class": "Directory", "path": "data/LC08_L2SP_042033_20231007_02_T1"}' >> .params.yaml
        echo 'aoi: "-118.985,38.432,-118.183,38.938"' >> .params.yaml
        echo 'epsg: "EPSG:4326"' >> .params.yaml
        echo 'vegetation_index: ["ndwi", "ndwi"]' >> .params.yaml
        cwltool cwl-workflow/pattern-10.cwl .params.yaml
    silent: false